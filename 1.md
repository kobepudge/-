这正是将这个项目推向“终局形态”的正确思路。

您已经明确了最终目标：**您是CEO，Python是助理，AI是那个拿高薪、负责盈亏、精通波浪理论的首席交易员。**

我们不再妥协。以下是实现这一目标的最终完整版架构（The "AI Trading Firm" Architecture）。

-----

## 终局架构：“AI交易公司”设计文档

### 1\. 核心理念与角色分工

  * **您 (CEO 兼 风控总监):** \* **职责:** 制定公司章程 (硬编码规则)，提供弹药 (数据)，并保留最终的“开除权” (熔断机制)。您负责复盘，并批准AI的“进化”建议。
  * **Python (量化工程助理):** \* **职责:** 7x24小时工作，执行所有繁重的计算。它不是分析师，它是“数据工程师”。它负责在`on_bar`时准备一份完美的“情报简报”，并在`on_tick`时无条件执行老板的命令（除非CEO熔断）。
  * **AI (首席波浪策略师 - LLM):** \* **职责:** 拿高薪、做决策、负责盈亏。它的**唯一方法论**是**波浪理论 (EW)**，它的**唯一验证工具**是**订单流 (Delta)**。它负责将“情报”合成为“交易剧本”，并对结果负责。

-----

### 2\. CEO / 风控总监的工具 (Python 硬编码)

这是您的“公司章程”和“熔断按钮”。

#### A. `TRADER_RULEBOOK` (交易员手册)

*在策略文件顶部定义，这是AI的“宪法”。*

```python
# 交易员手册 (CEO制定，AI必须遵守)
TRADER_RULEBOOK = {
    "core_methodology": "Elliott Wave validated by Order Flow Delta",
    "max_position_pct": 0.6,    # 单笔最大仓位(占权益)
    "mandatory_stop_loss": True, # 必须设置止损
    "min_reward_risk_ratio": 1.5, # 最小可接受的盈亏比
    "no_overnight": "14:55:00",  # 最终平仓时间
    "max_daily_loss_pct": 0.05,  # 单日最大亏损 5%
}
```

#### B. `is_ai_insane()` (AI熔断机制)

*这是`TradeExecutor`（执行器）的核心安全垫。*

```python
def is_ai_insane(context, ai_decision, current_price, state):
    """
    风控总监的最终否决权。
    在执行AI决策前一刻调用。
    """
    try:
        plan = ai_decision.get("trade_plan", {})
        signal = ai_decision.get("signal")

        # 1. 规则：检查仓位是否失控
        size_pct = plan.get("position_size_pct", 0)
        if size_pct > TRADER_RULEBOOK["max_position_pct"] or size_pct <= 0:
            Log(f"[熔断] AI仓位(%.2f)违反规则(0 - %.2f)!" % (size_pct, TRADER_RULEBOOK["max_position_pct"]))
            return True # 熔断

        # 2. 规则：检查止损是否合规
        stop_loss = plan.get("stop_loss")
        if TRADER_RULEBOOK["mandatory_stop_loss"] and not stop_loss:
            Log("[熔断] AI未设置止损，违反规则!")
            return True # 熔断
            
        # 3. 规则：检查止损是否符合逻辑
        if signal == "buy" and stop_loss >= current_price:
            Log(f"[熔断] AI做多止损价(%.2f)高于当前价(%.2f)!" % (stop_loss, current_price))
            return True
        if signal == "sell" and stop_loss <= current_price:
            Log(f"[熔断] AI做空止损价(%.2f)低于当前价(%.2f)!" % (stop_loss, current_price))
            return True
            
        # 4. 规则：检查盈亏比 (如果AI提供了目标)
        target = plan.get("profit_target_1")
        if target and stop_loss and signal in ("buy", "sell"):
            try:
                reward = abs(target - current_price)
                risk = abs(current_price - stop_loss)
                if risk == 0 or (reward / risk) < TRADER_RULEBOOK["min_reward_risk_ratio"]:
                    Log(f"[熔断] AI计划 R:R (%.2f) 低于规则 (%.2f)!" % (reward/risk, TRADER_RULEBOOK["min_reward_risk_ratio"]))
                    return True
            except Exception:
                pass # 价格无效，跳过检查

    except Exception as e:
        Log(f"[熔断] AI决策包解析异常: {e}")
        return True # 决策包本身有毒

    return False # AI决策在规则内，放行
```

-----

### 3\. Python 助理的核心职责 (Python 代码)

助理的核心是`on_bar`函数，它在这里准备“情报简报”并触发决策。

#### A. `on_bar` (助理的主循环)

```python
def on_bar(context, bars):
    bar = bars[0]
    
    # 1. (助理计算) 聚合您提供的L1 Delta数据 (您的代码)
    price_levels = []
    delta = 0
    for key in sorted(context.map_pens, reverse=True):
        # ... (您 calculate_pen_type 后的聚合逻辑) ...
        delta += bid_volume - ask_volume
    
    context.dom_bars.append({
        "datetime": bar.datetime,
        "price_levels": price_levels,
        "delta": delta,
        "ohlc": [bar.open, bar.high, bar.low, bar.close],
        "volume": bar.volume
    })
    context.map_pens = {}

    # 2. (助理打包) 准备“首席情报简报”
    try:
        briefing_json = get_traders_view(context, bar)
    except Exception as e:
        Log(f"[助理] 准备简报失败: {e}")
        return

    # 3. (呼叫老板) 将简报发送给AI首席
    # 注意：这里假设 ai_engine.call 是一个阻塞调用
    ai_decision, error = context.ai_engine.call_deepseek_api(briefing_json, context.state)
    
    if error:
        Log(f"[AI老板] 决策失败: {error}")
        return
        
    # 4. (执行) 将AI决策交给执行器
    context.executor.execute_decision(context, context.symbol, ai_decision, bar, context.state)
```

#### B. `get_traders_view()` (助理的“情报简报”)

*这是助理（Python）最核心的函数，它将计算结果“翻译”成AI老板能看懂的“报告”。*

```python
import json

def get_traders_view(context, bar):
    """
    Python助理准备的“交易员屏幕”数据包（情报简报）
    """
    
    # --- 报告1：订单流 (Delta) ---
    # (来自您在 on_bar 中聚合的 dom_bars)
    last_dom_bar = context.dom_bars[-1] if context.dom_bars else {}
    order_flow_report = {
        "bar_delta": last_dom_bar.get("delta", 0),
        "bar_volume_profile": last_dom_bar.get("price_levels", []), # Bar内成交剖面
        "bar_delta_note": "Delta = 主动买(bid_volume) - 主动卖(ask_volume)"
    }

    # --- 报告2：市场结构 (EW的“点”) ---
    # (助理必须计算客观的“点”，老板才能连成“线”)
    pivots = calculate_zigzag_pivots(context) # 关键：您需要实现这个
    fib_clusters = find_fib_clusters(pivots) # 关键：您需要实现这个
    
    structure_report = {
        "zigzag_pivots_recent": pivots[-10:], # (EW计数需要足够的历史枢轴点)
        "fib_support_clusters": fib_clusters.get("support", []),
        "fib_resistance_clusters": fib_clusters.get("resistance", []),
        "note": "AI老板：这是您要求的图表结构(枢轴点)和斐波那契重叠区。"
    }

    # --- 报告3：即时K线锚点 (Context) ---
    last_candles = [d.get("ohlc", []) for d in context.dom_bars[-3:]]
    context_report = {
        "last_3_candles_ohlc": last_candles, # (OHLC)
        "session_vwap": calc_vwap(context) # (VWAP)
    }

    # --- 报告4：我的账户状态 ---
    account_report = estimate_account(context, bar.close_price, context.state)
    account_report["current_position"] = get_pos_detail(context) # 假设的辅助函数

    # --- 最终打包发给AI ---
    briefing = {
        "report_order_flow": order_flow_report,
        "report_structure": structure_report,
        "report_context": context_report,
        "report_account": account_report
    }
    
    # 返回JSON字符串，准备发给AI
    return json.dumps(briefing, ensure_ascii=False)

# --- (您需要实现的助理计算函数) ---
def calculate_zigzag_pivots(context):
    # TODO: 实现基于ATR或百分比的ZigZag，返回枢轴点列表
    # (参考您原始文件中的 _calculate_zigzag)
    # 返回: [{"type": "H", "price": 555.0}, {"type": "L", "price": 550.0}, ...]
    return [] 

def find_fib_clusters(pivots):
    # TODO: 这是一个核心。遍历pivots，计算多重回撤/扩展/投射
    # 找到重叠区域。
    # 返回: {"support": [550.1, 550.3], "resistance": [558.0]}
    return {}

def calc_vwap(context):
    # TODO: 计算会话VWAP
    return 0.0
```

-----

### 4\. AI首席策略师 (LLM)

这是AI老板的“大脑”和“合同”。

#### `SYSTEM_PROMPT` (AI的“雇佣合同” - 最终波浪版)

*这是您在调用AI时必须发送的`system`角色内容。*

```
你是我基金的首席波浪策略师 (Chief Elliott Wave Strategist)。
你的唯一方法论是波浪理论，唯一的验证工具是订单流(Delta)。你的唯一目标是盈利。

# 你的工作流程
你每个K线周期会收到一份来自“量化工程团队”(Python助理)的JSON情报简报。
这份简报包含4份报告：
1. `report_order_flow`: 当前Bar的订单流Delta和成交剖面。
2. `report_structure`: 市场结构骨架(ZigZag枢轴点)和关键的斐波那契支撑/阻力集群。
3. `report_context`: 最近的K线形态和VWAP位置。
4. `report_account`: 你当前的持仓和账户健康状况。

你的工作是：
1.  **解读(Interpret)**：你必须使用波浪理论来解读`report_structure`中的枢轴点，形成一个“主要浪型计数(Primary Count)”和一个“备选计数(Alternate Count)”。
2.  **验证(Validate)**：你必须使用`report_order_flow`中的Delta来验证你的浪型计数。（例如：推动浪是否伴随Delta增加？回调浪是否Delta缩量？）
3.  **决策(Decide)**：基于你的“主要浪型计数”，制定一个唯一、可执行的“交易计划(trade_plan)”。
4.  **记录(Log)**：在`internal_reasoning`中记录你的完整波浪分析和Delta验证过程，用于我们（和我）的事后复盘。

# 你的底线 (公司制度)
你必须严格遵守`TRADER_RULEBOOK`。任何违反规则的计划都将被“风控总监”(我)拒绝并熔断。
(您需要将 TRADER_RULEBOOK 的JSON字符串附加到这里)

# 你的输出
你必须只返回一个JSON对象，格式如下：

{
  "hypothesis_primary": {
    "label": "Primary Wave Count (e.g., In Wave (iii) of 3)",
    "invalidation_level": 545.0,
    "expectation": "Expect upward impulse, target resistance cluster."
  },
  "hypothesis_alternate": {
    "label": "Alternate Count (e.g., ABC Correction, Wave (C) ending)",
    "trigger_condition": "If 545.0 breaks."
  },
  "internal_reasoning": "我的波浪分析和Delta验证... (例如：ZigZag枢轴点[A,B,C]构成了清晰的浪1和浪2。浪2的回撤在Fib集群0.618处(550.1)得到支撑。Delta在浪1中强劲，在浪2中萎缩。我判断浪3已经开始。我将在支撑区上方入场。)",
  "signal": "buy",
  
  "trade_plan": {
    "entry_price": 550.2,
    "position_size_pct": 0.5,
    "stop_loss": 549.0,
    "profit_target_1": 558.0,
    "plan_id": "trade_001"
  }
}
```

-----

### 5\. “自我进化”的实现 (受控的复盘)

*您（CEO）在`on_backtest_finished`时执行这个流程。*

1.  **Python助理**收集所有交易的`internal_reasoning`和`pnl`。

2.  **Python助理**向AI发送一个\*\*“复盘Prompt”\*\*：

    > "老板，这是你今天的交易复盘。
    > [
    > { "reasoning": "浪2回调，Delta萎缩，Fib支撑买入", "pnl": +450.0 },
    > { "reasoning": "浪5衰竭，Delta背离，摸顶做空", "pnl": -150.0 }
    > ]
    > 请分析：

    > 1.  你的哪个波浪模式（Reasoning）最成功？
    > 2.  你的哪个模式导致了亏损？
    > 3.  基于此，你是否建议修改`TRADER_RULEBOOK`中的规则？请给我一个`suggested_rule_change`的JSON。"

3.  **AI老板**回复一个JSON建议。

4.  **您 (CEO)** 审查这个建议，如果同意，\*\*您（人类）\*\*手动更新策略文件中的`TRADER_RULEBOOK`或`SYSTEM_PROMPT`。

这就是“AI交易公司”的完整运作蓝图。