# 快速修复总结 - "行情接口未连接"问题

## 🔴 问题现象

```
运行模拟盘时报错:
❌ 行情接口未连接
❌ 策略无法启动
```

---

## ✅ 根本原因

通过对比官方示例代码,发现**3个关键问题**:

1. **错误的合约代码**: 使用了 `au2512.SHFE` (特定月份合约,可能已过期)
2. **缺失on_start()函数**: 没有在数据订阅完成后验证数据加载
3. **subscribe()格式问题**: 使用了多余的参数

---

## 🔧 修复内容

### 修复1: 更换为主连合约

```python
# ❌ 修复前 (Line 23)
SYMBOL = "au2512.SHFE"  # 2025年12月交割,可能已过期

# ✅ 修复后
SYMBOL = "au6666.SHFE"  # 主连合约,永不过期
```

**原因**:
- `au2512` = 2025年12月交割的合约,可能已临近交割日或数据不全
- `au6666` = 主力连续合约,平台自动切换到成交量最大的月份合约

---

### 修复2: 添加on_start()数据验证

```python
# ✅ 新增函数 (Lines 670-687)
def on_start(context):
    """策略启动后的回调 - 在on_init之后,数据订阅完成后执行"""
    Log("策略启动完成,开始获取历史数据...")

    # 验证数据是否可用
    am_1m = get_market_data(context.symbol, '1m')
    am_1d = get_market_data(context.symbol, '1d')

    if am_1m and am_1m.count > 0:
        Log(f"1分钟K线数据加载成功: {am_1m.count}根")
    else:
        Log("[警告] 1分钟K线数据加载失败")

    if am_1d and am_1d.count > 0:
        Log(f"日线数据加载成功: {am_1d.count}根")
    else:
        Log("[警告] 日线数据加载失败")
```

**原因**:
- Gkoudai平台的数据订阅是**异步**的
- `on_init()` 执行时数据可能还未加载完成
- `on_start()` 在数据订阅完成后执行,是验证数据的最佳时机

---

### 修复3: 简化subscribe()调用

```python
# ❌ 修复前 (Lines 624-626)
subscribe(context.symbol, '1m', Config.KLINE_1M_WINDOW, wait_group=False)
subscribe(context.symbol, '1d', Config.KLINE_1D_WINDOW, wait_group=False)

# ✅ 修复后 (Lines 644-645)
subscribe(context.symbol, '1m', Config.KLINE_1M_WINDOW)
subscribe(context.symbol, '1d', Config.KLINE_1D_WINDOW)
```

**原因**:
- 官方示例代码不使用 `wait_group` 参数
- 多余参数可能导致平台版本兼容性问题

---

## 📊 对比表

| 项目 | 修复前 | 修复后 |
|------|--------|--------|
| **合约** | au2512.SHFE (固定月份) | au6666.SHFE (主连) |
| **on_start()** | ❌ 不存在 | ✅ 存在 (验证数据) |
| **subscribe()** | 3个参数 (含wait_group) | 2个参数 (标准格式) |
| **数据验证** | ❌ 无验证 | ✅ 启动时验证 |

---

## 🎯 预期效果

### 修复前

```
[09:00:00] 策略初始化...
[09:00:00] 订阅数据: au2512.SHFE
[09:00:01] ❌ 行情接口未连接
```

### 修复后

```
[09:00:00] 策略初始化...
[09:00:00] 订阅数据: au6666.SHFE
[09:00:01] ✅ 策略启动完成,开始获取历史数据...
[09:00:02] ✅ 1分钟K线数据加载成功: 200根
[09:00:02] ✅ 日线数据加载成功: 50根
[09:02:00] [调试] 满足AI调用条件, 开始更新数据...
[09:02:01] [AI决策] 调用DeepSeek API...
```

---

## 🧪 验证步骤

### 1️⃣ 上传修复后的代码

确认文件: `gkoudai_au_strategy_autonomous.py`

### 2️⃣ 回测验证

```
品种: au6666.SHFE
时间: 2024-11-01 至 2024-11-03
初始资金: 100000
```

**预期**: 能正常启动,看到数据加载日志

### 3️⃣ 检查日志

**必须看到以下日志才算成功**:

```
✅ 策略启动完成,开始获取历史数据...
✅ 1分钟K线数据加载成功: XXX根
✅ 日线数据加载成功: XXX根
```

如果看到:

```
❌ [警告] 1分钟K线数据加载失败
```

说明仍有问题,需进一步排查。

---

## 🔍 如果仍然失败

### 可能原因1: 合约代码输入错误

**检查**: 必须是 `au6666.SHFE`, 注意:
- ✅ 小写 `au`
- ✅ 中间是 `6666` (4个6)
- ✅ 后缀是 `.SHFE` (大写)

### 可能原因2: 非交易时间

**黄金期货交易时间**:
- 夜盘: 21:00 - 02:30
- 日盘: 09:00 - 15:00
- 周末和法定节假日不交易

**解决**: 在交易时间内测试,或先跑回测

### 可能原因3: 平台暂时无数据

**解决**: 尝试其他主连合约测试,如:
- `rb6666.SHFE` (螺纹钢主连)
- `ag6666.SHFE` (白银主连)

如果其他合约能跑通,说明只是黄金数据暂时不可用。

---

## 📋 改动文件清单

```
修改文件:
- gkoudai_au_strategy_autonomous.py (3处修改)
  - Line 23: SYMBOL 改为 au6666.SHFE
  - Lines 644-645: 简化 subscribe() 调用
  - Lines 670-687: 新增 on_start() 函数

新增文件:
- DEPLOYMENT_GUIDE.md (完整部署指南)
- QUICK_FIX_SUMMARY.md (本文档)
```

---

## ✅ 修复完成!

**核心变更**: 3行代码修改 + 1个新函数

**修复类型**: 数据订阅逻辑修复

**影响范围**: 仅影响策略启动阶段,不影响交易逻辑

**风险评估**: ✅ 低风险 (只是修正了订阅方式)

---

**现在请上传代码进行测试,并反馈日志结果!**

---

**文档版本**: v1.0
**修复日期**: 2025-11-03
**修复人员**: Claude Code
