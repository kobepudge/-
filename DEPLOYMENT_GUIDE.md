# 部署指南 - AI自主交易策略

## 🎯 当前状态

**所有API兼容性问题已修复**, 包括最关键的市场数据连接问题。

---

## 📋 修复汇总

### 最新修复 (2025-11-03 针对"行情接口未连接"错误)

| 修改项 | 原值 | 新值 | 原因 |
|-------|------|------|------|
| **合约代码** | `au2512.SHFE` | `au6666.SHFE` | 主连合约永不过期 |
| **subscribe()格式** | `subscribe(..., wait_group=False)` | `subscribe(...)` | 匹配官方示例格式 |
| **新增函数** | 无 | `on_start()` | 在订阅完成后验证数据 |

### 核心文件

```
gkoudai_au_strategy_autonomous.py  (885行, 完整策略代码)
```

---

## 🚀 部署步骤

### 1️⃣ 上传代码到Gkoudai平台

```bash
# 确认文件存在
ls -lh gkoudai_au_strategy_autonomous.py

# 文件位置
/Users/caifang/Downloads/纯量化方向/gkoudai_au_strategy_autonomous.py
```

**操作**:
1. 登录 Gkoudai 平台
2. 进入"策略管理"
3. 点击"新建策略"或"更新策略"
4. 复制完整代码粘贴进去
5. 保存

---

### 2️⃣ 配置回测参数 (先回测验证)

```python
品种: au6666.SHFE
时间: 2024-11-01 至 2024-11-03 (选择近期有数据的日期)
初始资金: 100000 (10万)
手续费: 平台默认
```

**预期结果**:
- ✅ 回测能正常启动,不报"行情接口未连接"错误
- ✅ 能看到日志输出:
  ```
  策略启动完成,开始获取历史数据...
  1分钟K线数据加载成功: 200根
  日线数据加载成功: 50根
  ```

---

### 3️⃣ 检查日志输出

**关键日志标志**:

✅ **成功标志**:
```
========== AI自主交易策略启动 ==========
交易品种: au6666.SHFE
策略启动完成,开始获取历史数据...
1分钟K线数据加载成功: 200根
日线数据加载成功: 50根
[调试] 满足AI调用条件, 开始更新数据...
[AI决策] 调用DeepSeek API...
```

❌ **失败标志**:
```
[警告] 1分钟K线数据加载失败
行情接口未连接
```

如果看到失败标志,请截图完整日志反馈。

---

### 4️⃣ 观察AI决策 (回测成功后)

**第一次AI调用**应该在策略启动约2分钟后出现:

```
[调试] 满足AI调用条件, 开始更新数据...
[AI决策] 调用DeepSeek API...
[AI决策] API响应: {...}
AI决策: hold (或 buy/sell/close)
市场状态: SIDEWAYS
AI信心度: 0.45
AI推理: 当前市场震荡,EMA20/60纠缠,无明确方向...
```

**检查点**:
- AI能否正常调用 (2分钟一次)
- 返回的决策格式是否正确
- 推理是否合理

---

### 5️⃣ 实盘模拟测试 (回测成功后)

**前提**: 回测能跑通,无API错误

**操作**:
1. 在平台选择"模拟交易"
2. 选择 `au6666.SHFE`
3. 设置初始资金10万
4. 启动策略

**交易时间**:
- 夜盘: 21:00 - 02:30
- 日盘: 09:00 - 15:00

**注意**: 非交易时间会报"行情接口未连接",这是正常的!

---

## 🔍 问题排查

### 问题1: 仍然报"行情接口未连接"

**可能原因**:
1. 合约代码输入错误 (必须是 `au6666.SHFE`, 注意大小写)
2. 非交易时间启动 (周末或非交易时段)
3. Gkoudai平台暂时无该品种数据

**解决**:
1. 检查代码第23行: `SYMBOL = "au6666.SHFE"`
2. 确认当前是交易时间
3. 尝试其他主连合约如 `rb6666.SHFE` (螺纹钢)

---

### 问题2: on_start() 不执行

**症状**: 没有看到"策略启动完成,开始获取历史数据..."日志

**原因**: Gkoudai平台版本可能不支持 `on_start()` 回调

**解决**: 不影响核心逻辑,`on_tick()` 仍会正常执行

---

### 问题3: AI不调用或调用失败

**症状**:
```
DeepSeek API调用失败: timeout
```

**解决**:
1. 检查API Key是否正确: `sk-c7c94df2cbbb423698cb895f25534501`
2. 检查网络连接
3. 增加 `API_TIMEOUT` 从10秒改为30秒 (Line 45)

---

### 问题4: 订单提交失败

**症状**:
```
订单提交失败: buy() 函数未定义
```

**原因**: 这个问题已在之前的修复中解决,如果出现说明代码未更新

**解决**:
1. 重新上传最新代码
2. 检查 `TradeExecutor.execute_decision()` 函数 (Lines 462-528)
3. 确认使用的是 `buy()`, `short()`, `send_target_order()` 而非 `order_volume()`

---

## 📊 预期性能指标

基于策略设计,预期表现:

| 指标 | 预期值 | 说明 |
|------|--------|------|
| **AI决策频率** | 每2分钟1次 | 30次/小时,120次/4小时交易时段 |
| **日均交易次数** | 5-10次 | AI挑剔,只在高信心度(>0.6)时入场 |
| **单笔持仓时间** | 5-30分钟 | 日内交易,不过夜 |
| **胜率** | 45-60% | 高度依赖AI决策质量 |
| **盈亏比** | 2:1 - 3:1 | AI动态计算止损止盈 |

**成本**:
- DeepSeek API: 120次/天 × ¥0.00014/次 = **¥0.017/天**
- 交易手续费: 按平台标准

---

## ✅ 验收标准

### 阶段1: 回测验收 (必须通过)

- [ ] 回测能启动,不报API错误
- [ ] 能看到 `on_start()` 日志,数据加载成功
- [ ] AI每2分钟调用一次
- [ ] AI决策格式正确 (buy/sell/hold/close + confidence + reasoning)
- [ ] 有交易信号时,订单能提交 (即使不成交)

### 阶段2: 模拟盘验收 (建议观察3-5天)

- [ ] 实时行情下AI决策合理
- [ ] 订单能成交
- [ ] 止损止盈能触发
- [ ] 强制平仓机制生效 (14:55自动平仓)
- [ ] 无频繁报错

### 阶段3: 小资金实盘 (确认前两阶段通过后)

- [ ] 1-2万资金测试3-5天
- [ ] 盈亏符合预期波动范围
- [ ] AI决策质量稳定
- [ ] 没有出现异常大额亏损

---

## 📞 反馈模板

如果遇到问题,请按以下格式反馈:

```
### 问题描述
[简短描述问题,如:"仍然报行情接口未连接"]

### 执行环境
- 测试类型: 回测 / 模拟盘 / 实盘
- 合约代码: [如 au6666.SHFE]
- 启动时间: [如 2024-11-03 10:00]

### 日志截图
[粘贴完整日志,特别是错误部分]

### 已检查项
- [ ] 合约代码确认是 au6666.SHFE
- [ ] 代码已重新上传最新版本
- [ ] 在交易时间内测试
```

---

## 🎓 学习资源

- **API文档**: [Gkoudai官方文档](https://quant.gkoudai.com/#/docs/index?url=/api_docs/py_portfolio/quick_start.html)
- **API修复总结**: `API_FIX_SUMMARY.md`
- **版本对比**: `VERSION_COMPARISON.md` (规则辅助版 vs AI自主版)
- **详细说明**: `README_AUTONOMOUS.md`

---

## 🔄 下一步优化方向 (策略稳定后)

1. **Prompt优化**: 根据AI实际表现调整决策Prompt
2. **止损止盈优化**: 分析AI设置的止损止盈是否合理
3. **仓位管理优化**: 根据信心度动态调整仓位
4. **市场状态识别优化**: 增强CAPITULATION/BLOW_OFF等极端状态识别
5. **多品种扩展**: 复制策略到其他期货品种

---

**部署完成!** 请按步骤操作,有任何问题随时反馈日志截图。

---

**文档版本**: v2.0
**最后更新**: 2025-11-03
**修复状态**: ✅ 所有已知API问题已解决
