# AI自主交易策略 - 最大化AI决策权版本

## 核心理念

> "数据给AI,让他做决策,我们只做最后风控"

这个版本基于一个核心哲学:**最小化人为规则,最大化AI自主权**。我们相信DeepSeek这样的大语言模型具备足够的市场理解能力,不需要我们预设复杂的交易规则。

### 与传统量化策略的区别

| 维度 | 传统量化策略 | AI自主交易策略 |
|------|------------|---------------|
| **决策逻辑** | 硬编码规则 (if-then) | AI自主判断 |
| **止损止盈** | 固定百分比 | 动态计算 (基于技术位、波动率、趋势强度) |
| **仓位管理** | 固定仓位 | AI根据信心度调整 (50%-100%) |
| **市场状态** | 预定义分类 | AI实时识别 |
| **策略调整** | 修改代码 | 调整Prompt |
| **极端行情** | 触发止损离场 | AI判断是反转机会还是真正风险 |

### 我们只做四件事

1. **提供完整市场数据** - tick行情、K线、技术指标、持仓状态
2. **构造高质量Prompt** - 清晰的角色定义、数据格式、输出要求
3. **执行AI决策** - 忠实执行AI给出的buy/sell/hold/close信号
4. **强制风控边界** - 单笔最大亏损2%、单日最大亏损5%、14:55强制平仓

## 关键特性

### 1. 极端量能识别 (核心优势)

AI能自主判断**"放量最后一跌"**(capitulation bottom)和**"放量顶部"**(blow-off top):

```
量能比 > 3.0x + 价格下跌 + RSI<20
→ AI判断: 这是恐慌性抛售,可能是超跌反弹机会

量能比 > 3.0x + 价格上涨 + RSI>80
→ AI判断: 这是多头狂热,可能是见顶信号
```

**关键点**: 不是简单的"放量=趋势确认",而是AI根据价格位置、技术指标、量能结构综合判断是继续还是反转。

### 2. 动态止损止盈

AI不使用固定的0.5%/1%止损,而是基于:
- **技术支撑/阻力位** (如前期低点、EMA20位置)
- **ATR波动率** (高波动品种用更宽的止损)
- **趋势强度** (强趋势允许更大回撤,弱趋势快速止损)
- **风险收益比** (建议≥2:1,但AI可调整)

示例AI决策:
```json
{
  "stop_loss": 548.00,
  "stop_loss_reason": "跌破20周期低点548.20,且量能衰竭",
  "profit_target": 555.00,
  "profit_target_reason": "前期高点阻力位555.30,风险收益比3:1"
}
```

### 3. 信心度驱动的仓位管理

```python
信心度 0.9-1.0 → 满仓 (100%)
信心度 0.7-0.9 → 重仓 (70%)
信心度 0.6-0.7 → 半仓 (50%)
信心度 < 0.6   → 不交易 (系统拒绝)
```

AI自己评估交易机会的质量,不再是所有信号都用同样仓位。

### 4. 失效条件 (Invalidation Condition)

这是从专业加密货币交易中借鉴的概念。AI不仅要说**何时入场**,还要说**何时认错**:

```json
{
  "signal": "buy_to_enter",
  "entry_price": 550.50,
  "stop_loss": 548.00,
  "invalidation_condition": "如果RSI重新跌破30,说明反弹失败,立即止损"
}
```

这确保AI有完整的交易逻辑,而不是只会开仓不会平仓。

## 架构设计

```
┌─────────────────────────────────────────────────────────────┐
│                        Tick数据流                             │
│                  (au2512每秒多次tick更新)                     │
└─────────────────────┬───────────────────────────────────────┘
                      │
                      ▼
         ┌────────────────────────┐
         │  MarketDataCollector   │
         │  - 缓存tick数据         │
         │  - 聚合K线数据          │
         │  - 计算技术指标         │
         └────────┬───────────────┘
                  │ (每2分钟)
                  ▼
         ┌────────────────────────┐
         │  构造AI Prompt          │
         │  - 当前行情             │
         │  - 技术指标             │
         │  - 持仓状态             │
         │  - 量能分析             │
         └────────┬───────────────┘
                  │
                  ▼
         ┌────────────────────────┐
         │  DeepSeek API           │
         │  "你是专业交易员..."     │
         │  返回: JSON决策          │
         └────────┬───────────────┘
                  │
                  ▼
         ┌────────────────────────┐
         │  TradeExecutor          │
         │  执行buy/sell/close     │
         └────────┬───────────────┘
                  │
                  ▼
         ┌────────────────────────┐
         │  RiskController         │ ◄── 每个tick检查!
         │  - 单笔最大亏损2%       │
         │  - 单日最大亏损5%       │
         │  - 强制14:55平仓        │
         │  - AI设定的止损止盈     │
         └────────────────────────┘
```

### 数据流说明

1. **Tick级别** (毫秒级): 收集价格、量能、买卖盘数据
2. **AI决策** (2分钟间隔): 平衡成本(0.014元/次)和响应速度
3. **风控检查** (每个tick): 确保任何时候都不会超过安全边界

## 部署指南

### 1. 上传到Gkoudai平台

1. 登录 https://quant.gkoudai.com/
2. 进入"策略开发" → "新建策略"
3. 复制 `gkoudai_au_strategy_autonomous.py` 的全部内容
4. 粘贴到平台编辑器
5. 点击"保存"

### 2. 配置参数 (可选)

默认参数已经经过优化,如需调整:

```python
class Config:
    # AI决策频率 (秒)
    AI_DECISION_INTERVAL = 120  # 建议范围: 60-300秒

    # 安全边界
    MAX_SINGLE_TRADE_LOSS_PCT = 0.02  # 2%
    MAX_DAILY_LOSS_PCT = 0.05         # 5%
    MIN_AI_CONFIDENCE = 0.6           # 0.6-0.8
```

**成本估算**:
- AI调用频率: 120秒 → 每天120次调用
- DeepSeek成本: 120 × 0.00014元 ≈ **0.017元/天**
- 交易手续费: 假设10次交易 × 20元 ≈ **200元/天**

### 3. 回测

```python
# 在平台上设置回测参数
起始时间: 2024-10-01
结束时间: 2024-12-31
初始资金: 100,000元
标的: au2512.SHFE
```

### 4. 实盘运行

**重要提醒**:
1. 先用小资金测试 (1-2万元)
2. 观察3-5天,确认AI决策符合预期
3. 检查日志,确保没有异常错误
4. 逐步增加资金

## AI决策示例

### 场景1: 放量最后一跌 (超跌反弹)

**市场数据**:
```
当前价格: 548.50 (日内-2.3%)
量能比: 3.5x (极端放量)
RSI: 18 (极度超卖)
MACD: 负值但柱状图收窄
K线: 长下影线,价格快速企稳
```

**AI决策**:
```json
{
  "market_state": "CAPITULATION",
  "reasoning": "价格连续下跌后出现3.5倍放量,RSI跌至18极度超卖区域,长下影线显示抛压衰竭。当前价格548.50接近日内低点548.20,该位置是明显的恐慌性抛售,不是趋势延续。MACD柱状图开始收窄,显示下跌动能减弱。综合判断这是放量最后一跌,具备反弹条件。",
  "signal": "buy",
  "confidence": 0.75,
  "entry_price": 548.50,
  "stop_loss": 547.20,
  "stop_loss_reason": "跌破日内最低点548.20下方1元,若继续下跌说明判断错误",
  "profit_target": 552.50,
  "profit_target_reason": "回到日内均价位置,风险收益比约3:1",
  "invalidation_condition": "如果反弹无力,15分钟内未能站上549.00,立即离场",
  "position_size_pct": 0.7,
  "expected_holding_time_minutes": 20,
  "risk_reward_ratio": 3.1
}
```

### 场景2: 趋势中的回调 (顺势交易)

**市场数据**:
```
当前价格: 553.00
EMA20: 551.50, EMA60: 549.00 (多头排列)
量能比: 0.7x (缩量)
MACD: 正值,柱状图略微收窄
价格: 回踩EMA20附近
```

**AI决策**:
```json
{
  "market_state": "WEAK_UPTREND",
  "reasoning": "EMA20>EMA60显示上升趋势完好,MACD仍在零轴上方。当前价格553.00回踩EMA20(551.50),且缩量至0.7x,说明这是正常的趋势回调而非趋势反转。多头排列未破坏,适合逢低买入。",
  "signal": "buy",
  "confidence": 0.68,
  "entry_price": 553.00,
  "stop_loss": 550.00,
  "stop_loss_reason": "跌破EMA60(549.00),说明上升趋势破坏",
  "profit_target": 558.00,
  "profit_target_reason": "前期高点阻力位,风险收益比约1.7:1",
  "invalidation_condition": "如果价格无法在30分钟内站稳EMA20上方,说明回调可能加深",
  "position_size_pct": 0.6,
  "expected_holding_time_minutes": 45,
  "risk_reward_ratio": 1.7
}
```

### 场景3: 震荡市不交易

**市场数据**:
```
当前价格: 551.00
EMA20: 550.80, EMA60: 550.50 (纠缠)
MACD: 在0轴附近反复穿越
RSI: 48 (中性)
量能比: 0.9x
```

**AI决策**:
```json
{
  "market_state": "SIDEWAYS",
  "reasoning": "EMA20和EMA60距离极近(550.80 vs 550.50),MACD在0轴附近反复震荡,RSI处于中性区域48。价格在过去2小时内在549-552区间反复震荡,没有明确方向。量能正常但无突破迹象。这种震荡市场胜率低且止损频繁,不适合入场。",
  "signal": "hold",
  "confidence": 0.30,
  "reasoning_for_hold": "等待明确的方向性突破,或者量能放大配合价格突破区间上下沿"
}
```

## Prompt调优指南

### 如何让AI更激进?

修改 `construct_autonomous_trading_prompt()` 函数中的这些部分:

```python
# 1. 降低最小信心度
MIN_AI_CONFIDENCE = 0.5  # 从0.6降到0.5

# 2. 在Prompt中强调
"""
你的风格是积极主动的交易员,愿意在高概率机会中承担风险。
不要过度等待,当出现明确信号时果断入场。
"""

# 3. 增加决策频率
AI_DECISION_INTERVAL = 60  # 从120秒降到60秒
```

### 如何让AI更保守?

```python
# 1. 提高最小信心度
MIN_AI_CONFIDENCE = 0.75  # 从0.6提高到0.75

# 2. 在Prompt中强调
"""
你的风格是保守稳健的交易员,只在极高确定性机会中入场。
宁可错过,不可做错。风险收益比必须>2.5:1。
"""

# 3. 减少决策频率
AI_DECISION_INTERVAL = 180  # 从120秒增加到180秒
```

### 如何加入自定义规则?

在Prompt的"交易决策框架"部分添加:

```python
## 我的自定义规则

**必须遵守**:
1. RSI>70时禁止做多,RSI<30时禁止做空
2. 日内亏损超过3次后,必须降低仓位至30%
3. 14:00之后不开新仓,只允许平仓

**优先考虑**:
1. 成交量突破必须伴随价格突破才有效
2. 趋势交易优先于反转交易
3. 持仓时间尽量<30分钟,避免持仓过久
```

## 监控与日志

### 关键日志

系统会输出以下关键信息:

```
[2024-12-15 09:35:20] 正在调用AI进行决策...
[2024-12-15 09:35:22] AI决策: buy, 市场状态: CAPITULATION
[2024-12-15 09:35:22] AI分析: 价格连续下跌后出现3.5倍放量,RSI跌至18...
[2024-12-15 09:35:23] AI决策: 开多 2手 @ 548.50, 信心度=0.75
[2024-12-15 09:35:23] 止损=547.20, 止盈=552.50
[2024-12-15 09:45:10] 触发AI止盈 (552.50 >= 552.50), 平仓!
[2024-12-15 09:45:10] 订单成交: 卖出 2手 @ 552.50
```

### 需要关注的警告

```
⚠️ 触发单笔最大亏损限制 (-2.1%), 强制平仓!
⚠️ 触发单日最大亏损限制 (-5.2%), 停止交易!
⚠️ 到达强制平仓时间 14:55:00, 强制平仓!
⚠️ AI信心度不足 (0.55 < 0.60), 不执行交易
❌ API调用失败: 已达最大重试次数
```

## 风险提示

### 这个策略不能做什么

1. **不能预测黑天鹅事件** - 突发新闻、政策变动等AI无法预知
2. **不能保证盈利** - 再智能的AI也无法战胜市场的随机性
3. **不能替代风控** - 必须严格遵守最大亏损限制
4. **不能在流动性差的品种使用** - 可能出现滑点和无法成交

### 适用条件

✅ **适合**: 日内波段交易、流动性好的期货品种、有明确趋势或反转信号的市场
❌ **不适合**: 高频交易(毫秒级)、流动性差的小品种、长期持仓策略

### 建议

1. **初期用小资金** - 1-2万元测试3-5天
2. **关注AI决策质量** - 查看reasoning字段,判断AI逻辑是否合理
3. **定期review** - 每周复盘AI决策,发现问题及时调整Prompt
4. **保持学习** - 观察AI在不同市场状态下的表现,优化Prompt
5. **不要过度优化** - 避免根据短期结果频繁修改参数

## 常见问题

### Q1: AI决策的成本是多少?

A: DeepSeek的定价是每百万tokens约0.14元。平均每次决策消耗约1000 tokens(输入+输出),成本约0.00014元。按每天120次调用,每天成本约**0.017元**,完全可以忽略不计。

### Q2: AI会不会做出疯狂的决策?

A: 有以下保护机制:
1. **最小信心度0.6** - 低于此阈值不执行
2. **风控硬限制** - 单笔最大亏损2%,单日最大亏损5%
3. **强制平仓时间** - 14:55必须平仓
4. **Prompt约束** - 要求AI输出止损、止盈、失效条件

### Q3: 如何判断Prompt的质量?

好的Prompt应该让AI输出:
- ✅ 清晰的reasoning (不是模糊的"市场上涨")
- ✅ 具体的止损位置和理由 (不是"略低于当前价")
- ✅ 明确的失效条件 (不是"如果亏损就止损")
- ✅ 合理的风险收益比 (>1.5:1)

### Q4: AI调用失败怎么办?

系统有3次重试机制,且使用指数退避策略。如果连续失败:
1. 检查API Key是否正确
2. 检查网络连接
3. 查看DeepSeek服务状态
4. 降低调用频率 (AI_DECISION_INTERVAL改为300)

### Q5: 如何提高胜率?

不要过分追求胜率!职业交易员的胜率通常在50-60%。关键是:
- **盈亏比>2:1** - 赚的时候比亏的多
- **严格止损** - 小亏大赚
- **仓位管理** - 高确定性机会用重仓

## 进阶优化

### 1. 多时间周期分析

在Prompt中增加5分钟、15分钟K线数据:

```python
## 多周期分析
- 1分钟: {indicators_1m}
- 5分钟: {indicators_5m}
- 15分钟: {indicators_15m}

请综合多周期判断趋势强度。
```

### 2. 市场情绪指标

加入持仓量(Open Interest)变化、资金流向等:

```python
## 市场情绪
- 持仓量变化: +5000手 (多头增仓)
- 主力合约切换: au2506 → au2512
```

### 3. 自适应止损

让AI根据波动率动态调整:

```python
建议止损距离 = ATR * 1.5 (高波动市场用更宽止损)
```

### 4. 部分止盈

允许AI分批止盈:

```json
{
  "signal": "partial_close",
  "close_percentage": 0.5,
  "reason": "已达第一目标位,锁定部分利润"
}
```

## 总结

这个策略的核心是**信任AI的判断能力**,同时用**硬性风控边界**保护账户安全。它不是传统的"规则驱动"策略,而是"数据驱动+AI决策"的新范式。

**成功的关键**:
1. 高质量的Prompt工程
2. 完整的市场数据输入
3. 严格的风控边界
4. 持续的迭代优化

**记住**: AI是工具,不是圣杯。最终的交易系统成功与否,取决于你对市场的理解、对风险的管理、以及对策略的持续优化。

---

**版本**: v1.0-autonomous
**最后更新**: 2024-12-15
**作者**: 基于用户需求设计
**License**: MIT
